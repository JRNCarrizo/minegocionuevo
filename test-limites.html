<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Sistema de L√≠mites</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>üß™ Test Sistema de L√≠mites - MiNegocio</h1>
    
    <div class="container">
        <h2>Configuraci√≥n</h2>
        <div class="test-section info">
            <label for="baseUrl">URL Base:</label>
            <input type="text" id="baseUrl" value="http://localhost:8080" style="width: 300px; margin-left: 10px;">
            <br><br>
            <label for="empresaId">Empresa ID:</label>
            <input type="number" id="empresaId" value="1" style="width: 100px; margin-left: 10px;">
            <br><br>
            <label for="token">Token (opcional):</label>
            <input type="text" id="token" placeholder="Bearer token" style="width: 400px; margin-left: 10px;">
        </div>
    </div>

    <div class="container">
        <h2>Pruebas de L√≠mites</h2>
        
        <div class="test-section">
            <h3>1. Verificar L√≠mites de Empresa</h3>
            <button onclick="testLimites()">Obtener L√≠mites</button>
            <div id="resultLimites" class="result"></div>
        </div>

        <div class="test-section">
            <h3>2. Verificar Consumo de Empresa</h3>
            <button onclick="testConsumo()">Obtener Consumo</button>
            <div id="resultConsumo" class="result"></div>
        </div>

        <div class="test-section">
            <h3>2.5. Verificar Almacenamiento (Solo Archivos)</h3>
            <button onclick="testAlmacenamiento()">Obtener Almacenamiento</button>
            <div id="resultAlmacenamiento" class="result"></div>
        </div>

        <div class="test-section">
            <h3>2.6. Verificar Almacenamiento Total (Archivos + BD)</h3>
            <button onclick="testAlmacenamientoTotal()">Obtener Almacenamiento Total</button>
            <div id="resultAlmacenamientoTotal" class="result"></div>
        </div>

        <div class="test-section">
            <h3>3. Verificar si puede crear producto</h3>
            <button onclick="testPuedeCrearProducto()">Verificar Producto</button>
            <div id="resultProducto" class="result"></div>
        </div>

        <div class="test-section">
            <h3>4. Verificar si puede crear cliente</h3>
            <button onclick="testPuedeCrearCliente()">Verificar Cliente</button>
            <div id="resultCliente" class="result"></div>
        </div>

        <div class="test-section">
            <h3>5. Crear Producto (Test de L√≠mite)</h3>
            <button onclick="testCrearProducto()">Crear Producto de Prueba</button>
            <div id="resultCrearProducto" class="result"></div>
        </div>

        <div class="test-section">
            <h3>6. Crear Cliente (Test de L√≠mite)</h3>
            <button onclick="testCrearCliente()">Crear Cliente de Prueba</button>
            <div id="resultCrearCliente" class="result"></div>
        </div>

        <div class="test-section">
            <h3>7. Test Registrar Archivo</h3>
            <button onclick="testRegistrarArchivo()">Registrar Archivo de Prueba</button>
            <div id="resultRegistrarArchivo" class="result"></div>
        </div>
    </div>

    <div class="container">
        <h2>Logs</h2>
        <div id="logs" style="background-color: #f8f9fa; padding: 10px; border-radius: 5px; max-height: 300px; overflow-y: auto;"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            logEntry.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        function getHeaders() {
            const token = document.getElementById('token').value;
            const headers = {
                'Content-Type': 'application/json'
            };
            if (token) {
                headers['Authorization'] = token.startsWith('Bearer ') ? token : `Bearer ${token}`;
            }
            return headers;
        }

        function getBaseUrl() {
            return document.getElementById('baseUrl').value;
        }

        function getEmpresaId() {
            return document.getElementById('empresaId').value;
        }

        async function testLimites() {
            const resultDiv = document.getElementById('resultLimites');
            resultDiv.innerHTML = 'Cargando...';
            
            try {
                const response = await fetch(`${getBaseUrl()}/api/empresas/publico/${getEmpresaId()}/limites`, {
                    headers: getHeaders()
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `<div class="success">
                        <h4>‚úÖ L√≠mites obtenidos exitosamente</h4>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>`;
                    log('L√≠mites obtenidos exitosamente', 'success');
                } else {
                    resultDiv.innerHTML = `<div class="error">
                        <h4>‚ùå Error al obtener l√≠mites</h4>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>`;
                    log(`Error al obtener l√≠mites: ${response.status}`, 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">
                    <h4>‚ùå Error de conexi√≥n</h4>
                    <pre>${error.message}</pre>
                </div>`;
                log(`Error de conexi√≥n: ${error.message}`, 'error');
            }
        }

        async function testConsumo() {
            const resultDiv = document.getElementById('resultConsumo');
            resultDiv.innerHTML = 'Cargando...';
            
            try {
                const response = await fetch(`${getBaseUrl()}/api/empresas/publico/${getEmpresaId()}/consumo`, {
                    headers: getHeaders()
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `<div class="success">
                        <h4>‚úÖ Consumo obtenido exitosamente</h4>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>`;
                    log('Consumo obtenido exitosamente', 'success');
                } else {
                    resultDiv.innerHTML = `<div class="error">
                        <h4>‚ùå Error al obtener consumo</h4>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>`;
                    log(`Error al obtener consumo: ${response.status}`, 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">
                    <h4>‚ùå Error de conexi√≥n</h4>
                    <pre>${error.message}</pre>
                </div>`;
                log(`Error de conexi√≥n: ${error.message}`, 'error');
            }
        }

        async function testAlmacenamiento() {
            const resultDiv = document.getElementById('resultAlmacenamiento');
            resultDiv.innerHTML = 'Cargando...';
            
            try {
                const response = await fetch(`${getBaseUrl()}/api/empresas/publico/${getEmpresaId()}/almacenamiento`, {
                    headers: getHeaders()
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `<div class="success">
                        <h4>‚úÖ Almacenamiento (Solo Archivos) obtenido exitosamente</h4>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>`;
                    log('Almacenamiento (Solo Archivos) obtenido exitosamente', 'success');
                } else {
                    resultDiv.innerHTML = `<div class="error">
                        <h4>‚ùå Error al obtener almacenamiento</h4>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>`;
                    log(`Error al obtener almacenamiento: ${response.status}`, 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">
                    <h4>‚ùå Error de conexi√≥n</h4>
                    <pre>${error.message}</pre>
                </div>`;
                log(`Error de conexi√≥n: ${error.message}`, 'error');
            }
        }

        async function testAlmacenamientoTotal() {
            const resultDiv = document.getElementById('resultAlmacenamientoTotal');
            resultDiv.innerHTML = 'Cargando...';
            
            try {
                const response = await fetch(`${getBaseUrl()}/api/empresas/publico/${getEmpresaId()}/almacenamiento-total`, {
                    headers: getHeaders()
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `<div class="success">
                        <h4>‚úÖ Almacenamiento Total (Archivos + BD) obtenido exitosamente</h4>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>`;
                    log('Almacenamiento Total (Archivos + BD) obtenido exitosamente', 'success');
                } else {
                    resultDiv.innerHTML = `<div class="error">
                        <h4>‚ùå Error al obtener almacenamiento total</h4>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>`;
                    log(`Error al obtener almacenamiento total: ${response.status}`, 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">
                    <h4>‚ùå Error de conexi√≥n</h4>
                    <pre>${error.message}</pre>
                </div>`;
                log(`Error de conexi√≥n: ${error.message}`, 'error');
            }
        }

        async function testPuedeCrearProducto() {
            const resultDiv = document.getElementById('resultProducto');
            resultDiv.innerHTML = 'Verificando...';
            
            try {
                // Primero obtener l√≠mites
                const limitesResponse = await fetch(`${getBaseUrl()}/api/empresas/publico/${getEmpresaId()}/limites`, {
                    headers: getHeaders()
                });
                
                if (!limitesResponse.ok) {
                    throw new Error('No se pudieron obtener los l√≠mites');
                }
                
                const limitesData = await limitesResponse.json();
                const limites = limitesData.limites;
                
                const puedeCrear = limites.productosActuales < limites.maxProductos;
                const mensaje = puedeCrear 
                    ? `‚úÖ Puede crear productos (${limites.productosActuales}/${limites.maxProductos})`
                    : `‚ùå No puede crear m√°s productos (${limites.productosActuales}/${limites.maxProductos})`;
                
                resultDiv.innerHTML = `<div class="${puedeCrear ? 'success' : 'error'}">
                    <h4>${mensaje}</h4>
                    <pre>Productos actuales: ${limites.productosActuales}
M√°ximo permitido: ${limites.maxProductos}
Plan: ${limites.planNombre}</pre>
                </div>`;
                
                log(mensaje, puedeCrear ? 'success' : 'error');
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">
                    <h4>‚ùå Error al verificar</h4>
                    <pre>${error.message}</pre>
                </div>`;
                log(`Error al verificar: ${error.message}`, 'error');
            }
        }

        async function testPuedeCrearCliente() {
            const resultDiv = document.getElementById('resultCliente');
            resultDiv.innerHTML = 'Verificando...';
            
            try {
                // Primero obtener l√≠mites
                const limitesResponse = await fetch(`${getBaseUrl()}/api/empresas/publico/${getEmpresaId()}/limites`, {
                    headers: getHeaders()
                });
                
                if (!limitesResponse.ok) {
                    throw new Error('No se pudieron obtener los l√≠mites');
                }
                
                const limitesData = await limitesResponse.json();
                const limites = limitesData.limites;
                
                const puedeCrear = limites.clientesActuales < limites.maxClientes;
                const mensaje = puedeCrear 
                    ? `‚úÖ Puede crear clientes (${limites.clientesActuales}/${limites.maxClientes})`
                    : `‚ùå No puede crear m√°s clientes (${limites.clientesActuales}/${limites.maxClientes})`;
                
                resultDiv.innerHTML = `<div class="${puedeCrear ? 'success' : 'error'}">
                    <h4>${mensaje}</h4>
                    <pre>Clientes actuales: ${limites.clientesActuales}
M√°ximo permitido: ${limites.maxClientes}
Plan: ${limites.planNombre}</pre>
                </div>`;
                
                log(mensaje, puedeCrear ? 'success' : 'error');
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">
                    <h4>‚ùå Error al verificar</h4>
                    <pre>${error.message}</pre>
                </div>`;
                log(`Error al verificar: ${error.message}`, 'error');
            }
        }

        async function testCrearProducto() {
            const resultDiv = document.getElementById('resultCrearProducto');
            resultDiv.innerHTML = 'Creando producto de prueba...';
            
            try {
                const productoTest = {
                    nombre: `Producto Test ${Date.now()}`,
                    descripcion: "Producto de prueba para verificar l√≠mites",
                    precio: 10.99,
                    stock: 100,
                    stockMinimo: 10,
                    categoria: "Test",
                    marca: "Test Brand",
                    unidad: "unidad",
                    activo: true
                };
                
                const response = await fetch(`${getBaseUrl()}/api/empresas/publico/${getEmpresaId()}/productos`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify(productoTest)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `<div class="success">
                        <h4>‚úÖ Producto creado exitosamente</h4>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>`;
                    log('Producto creado exitosamente', 'success');
                } else if (response.status === 403) {
                    resultDiv.innerHTML = `<div class="error">
                        <h4>‚ùå L√≠mite de productos alcanzado</h4>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>`;
                    log('L√≠mite de productos alcanzado - Validaci√≥n funcionando correctamente', 'success');
                } else {
                    resultDiv.innerHTML = `<div class="error">
                        <h4>‚ùå Error al crear producto</h4>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>`;
                    log(`Error al crear producto: ${response.status}`, 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">
                    <h4>‚ùå Error de conexi√≥n</h4>
                    <pre>${error.message}</pre>
                </div>`;
                log(`Error de conexi√≥n: ${error.message}`, 'error');
            }
        }

        async function testCrearCliente() {
            const resultDiv = document.getElementById('resultCrearCliente');
            resultDiv.innerHTML = 'Creando cliente de prueba...';
            
            try {
                const clienteTest = {
                    nombre: "Cliente",
                    apellidos: `Test ${Date.now()}`,
                    email: `cliente.test.${Date.now()}@example.com`,
                    telefono: "123456789",
                    direccion: "Direcci√≥n de prueba"
                };
                
                const response = await fetch(`${getBaseUrl()}/api/empresas/publico/${getEmpresaId()}/clientes`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify(clienteTest)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `<div class="success">
                        <h4>‚úÖ Cliente creado exitosamente</h4>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>`;
                    log('Cliente creado exitosamente', 'success');
                } else if (response.status === 403) {
                    resultDiv.innerHTML = `<div class="error">
                        <h4>‚ùå L√≠mite de clientes alcanzado</h4>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>`;
                    log('L√≠mite de clientes alcanzado - Validaci√≥n funcionando correctamente', 'success');
                } else {
                    resultDiv.innerHTML = `<div class="error">
                        <h4>‚ùå Error al crear cliente</h4>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>`;
                    log(`Error al crear cliente: ${response.status}`, 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">
                    <h4>‚ùå Error de conexi√≥n</h4>
                    <pre>${error.message}</pre>
                </div>`;
                log(`Error de conexi√≥n: ${error.message}`, 'error');
            }
        }

        async function testRegistrarArchivo() {
            const resultDiv = document.getElementById('resultRegistrarArchivo');
            resultDiv.innerHTML = 'Registrando archivo de prueba...';
            
            try {
                const archivoTest = {
                    urlArchivo: "https://res.cloudinary.com/test/image/upload/v1234567890/test-producto.jpg",
                    publicId: "mi-negocio/empresa-1/producto/test-producto",
                    tipoArchivo: "producto",
                    tama√±oBytes: 1024000, // 1MB
                    nombreOriginal: "producto-test.jpg",
                    tipoMime: "image/jpeg"
                };
                
                const response = await fetch(`${getBaseUrl()}/api/empresas/publico/${getEmpresaId()}/test-archivo`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify(archivoTest)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `<div class="success">
                        <h4>‚úÖ Archivo registrado exitosamente</h4>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>`;
                    log('Archivo registrado exitosamente', 'success');
                } else {
                    resultDiv.innerHTML = `<div class="error">
                        <h4>‚ùå Error al registrar archivo</h4>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>`;
                    log(`Error al registrar archivo: ${response.status}`, 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">
                    <h4>‚ùå Error de conexi√≥n</h4>
                    <pre>${error.message}</pre>
                </div>`;
                log(`Error de conexi√≥n: ${error.message}`, 'error');
            }
        }

        // Auto-ejecutar pruebas al cargar
        window.onload = function() {
            log('P√°gina cargada. Configura los par√°metros y ejecuta las pruebas.', 'info');
        };
    </script>
</body>
</html>
